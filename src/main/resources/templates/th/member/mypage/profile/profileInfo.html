<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>프로필 수정</title>
    <script src="https://code.jquery.com/jquery-latest.js"></script>

</head>

<body>

<h2>프로필 수정</h2>


<div class="container">
    <form action="/modifyProfile" method="post" enctype="multipart/form-data">
        <div class="form-group">
            <label for="nickName">닉네임</label>

            <input type="text" id="nickName" name="nickName" th:text="${profile.nickName}" placeholder="입력하지 않을 시 아이디로 출력됩니다."/>
        </div>
        <div>
            <label for="uploadFile">프로필사진</label>
            <input type="file" id="uploadFile" name="uploadFile"/>
            <div id="preview" ><img th:src="@{'/uploadImg'+${profile.memberImg}}" style="width: 300px; height: 300px;"/></div>

        </div>

        <div class="form-group">
            <label for="memberIntro">한줄소개</label>
            <input type="text" id="memberIntro" name="memberIntro" th:text="${profile.memberIntro}"/>
        </div>

        <input type="submit" value="등록"/>
    </form>
</div>
</body>
<script type="text/javascript">
    $(document).ready(function (e){
        $("input[type='file']").change(function(e){

            //div 내용 비워주기
            $('#preview').empty();

            var files = e.target.files;
            var arr =Array.prototype.slice.call(files);

            //업로드 가능 파일인지 체크
            for(var i=0;i<files.length;i++){
                if(!checkExtension(files[i].name,files[i].size)){
                    return false;
                }
            }

            preview(arr);


        });//file change

        function checkExtension(fileName,fileSize){

            var regex = new RegExp("(.*?)\.(exe|sh|zip|alz)$");
            var maxSize = 10485760;  //10MB

            if(fileSize >= maxSize){
                alert('파일 사이즈 초과');
                $("input[type='file']").val("");  //파일 초기화
                return false;
            }

            if(regex.test(fileName)){
                alert('업로드 불가능한 파일이 있습니다.');
                $("input[type='file']").val("");  //파일 초기화
                return false;
            }
            return true;
        }

        function preview(arr){
            arr.forEach(function(f){

                //파일명이 길면 파일명...으로 처리
                var fileName = f.name;
                if(fileName.length > 10){
                    fileName = fileName.substring(0,7)+"...";
                }

                //div에 이미지 추가
                var str = '<div style="display: inline-flex; ">';
               // str += '<span>'+fileName+'</span><br>';

                //이미지 파일 미리보기
                if(f.type.match('image.*')){
                    var reader = new FileReader(); //파일을 읽기 위한 FileReader객체 생성
                    reader.onload = function (e) { //파일 읽어들이기를 성공했을때 호출되는 이벤트 핸들러
                        //str += '<button type="button" class="delBtn" value="'+f.name+'" style="background: red">x</button><br>';
                        str += '<img src="'+e.target.result+'" title="'+f.name+'" width=300 height=300 />';
                        str += '</li></div>';
                        $(str).appendTo('#preview');
                    }
                    reader.readAsDataURL(f);
                }else{
                    str += '<img src="/resources/img/fileImg.png" title="'+f.name+'" width=300 height=300 />';
                    $(str).appendTo('#preview');
                }
            });//arr.forEach
        }
    });
</script>
</html>