<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="th/layout/defaultLayout">
<head>
    <meta charset="UTF-8">
    <title>메인</title>
    <th:block layout:fragment="css">
        <link rel="stylesheet" th:href="@{/css/mainContent.css}">
    </th:block>
    <link th:href="@{/css/productPage.css}" rel="stylesheet"/>
    <!--    <link rel="stylesheet" th:href="@{https://www.w3schools.com/w3css/4/w3.css}">-->

    <script th:src="@{https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.css" />
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>

</head>
<body>
<div layout:fragment="content" class="mt-5">
    <div class="container">
        <div class="row">
            <!--            <div class="w3-content" style="max-width:400px">-->
            <!--                <img class="mySlides" th:src="@{'/uploadImg/'+${product.productMainImg}}"-->
            <!--                     style="width:100%;display:none">-->
            <!--                <img class="mySlides" th:src="@{'/uploadImg/'+${product.productSubImg1}}" style="width:100%">-->
            <!--                <img class="mySlides" th:src="@{'/uploadImg/'+${product.productSubImg2}}"-->
            <!--                     style="width:100%;display:none">-->

            <!--                <div class="w3-row-padding w3-section">-->
            <!--                    <div class="w3-col s4">-->
            <!--                        <img class="demo w3-opacity w3-hover-opacity-off"-->
            <!--                             th:src="@{'/uploadImg/'+${product.productMainImg}}" style="width:100%;cursor:pointer"-->
            <!--                             onclick="currentDiv(1)">-->
            <!--                    </div>-->
            <!--                    <div class="w3-col s4">-->
            <!--                        <img class="demo w3-opacity w3-hover-opacity-off"-->
            <!--                             th:src="@{'/uploadImg/'+${product.productSubImg1}}" style="width:100%;cursor:pointer"-->
            <!--                             onclick="currentDiv(2)">-->
            <!--                    </div>-->
            <!--                    <div class="w3-col s4">-->
            <!--                        <img class="demo w3-opacity w3-hover-opacity-off"-->
            <!--                             th:src="@{'/uploadImg/'+${product.productSubImg2}}" style="width:100%;cursor:pointer"-->
            <!--                             onclick="currentDiv(3)">-->
            <!--                    </div>-->
            <!--                </div>-->


            <div class="col-md-4">
                <div id="carouselExampleFade" class="carousel slide carousel-fade" data-ride="carousel">
                    <div class="carousel-inner">
                        <div class="carousel-item active">
                            <img th:src="@{'/uploadImg/'+${product.productMainImg}}" class="d-block w-100" alt="...">
                        </div>
                        <div class="carousel-item">
                            <img th:src="@{'/uploadImg/'+${product.productSubImg1}}" class="d-block w-100" alt="...">
                        </div>
                        <div class="carousel-item">
                            <img th:src="@{'/uploadImg/'+${product.productSubImg2}}" class="d-block w-100" alt="...">
                        </div>
                        <div class="carousel-item">
                            <img th:src="@{'/uploadImg/'+${product.productSubImg3}}" class="d-block w-100" alt="...">
                        </div>

                        <input type="hidden" id="productName" th:value="${product.productName}">
                        <input type="hidden" id="productNo" th:value="${product.productNo}">


                    </div>
                    <a class="carousel-control-prev" href="#carouselExampleFade" role="button" data-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="sr-only">Previous</span>
                    </a>
                    <a class="carousel-control-next" href="#carouselExampleFade" role="button" data-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="sr-only">Next</span>
                    </a>
                </div>
            </div>
            <div class="col-md-7">
                <div class="production-item-stats">
                    <h1 class="production-selling-header__title"><p
                            class="production-selling-header__title__brand-wrap"><a
                            class="production-selling-header__title__brand"
                            href="" th:value="${product.productNo}" th:text="${product.sellerName}"></a>
                    </p><span class="production-selling-header__title__name" th:value="${product.productName}"
                              th:text="${product.productName}" th:id="pName"></span>
                    </h1>
                    <h4><span class="production-selling-header__price__original"
                              th:text="${product.sellPrice}"></span></h4>
                    <h4><span class="production-selling-header__price__customer"
                              th:text="${product.customerPrice}"></span></h4>
                    <h4><span class="production-selling-header__price__purchase"
                              th:text="${product.purchasePrice}"></span></h4>
                </div>
                <form action="" method="post" th:object="${basketVO}">
                    <div class="input-group">
                        <select th:field="*{productColor}" class="custom-select col-md-7" th:id="inputGroupSelect01">
                            <option th:value selected>색상</option>
                            <option id="colorSelect" th:each="color : ${product.colorCodeVOList}"
                                    th:value="${color}"
                                    th:utext="${color}"/>
                        </select>
                    </div>
                    <div>
                        <select class="custom-select col-md-1" name="hohoBox">
                            <option th:value="1">1</option>
                            <option th:value="2">2</option>
                            <option th:value="3">3</option>
                            <option th:value="4">4</option>
                            <option th:value="5">5</option>
                            <option th:value="6">6</option>
                            <option th:value="7">7</option>
                            <option th:value="8">8</option>
                            <option th:value="9">9</option>
                            <option th:value="10">10</option>
                        </select>

                    </div>
                    <button type="submit" class="btn-basket" onclick="saveSessionStorage();
                    window.open('/basketPop', '_blank', 'width=300px,height=300px,resizable=no,scrollbars=no,status=no,left=0px,top=0px'); return false;">장바구니</button>
                        <a href="/basketPop" value="저장" onClick="saveSessionStorage(); return false;">저장</a>
                    <a href="/basketPop" rel="modal:open" onclick="saveSessionStorage();">모달창띄우기</a>
                    <button type="submit" class="btn-buy-now">바로구매</button>
                </form>
            </div>
        </div>


        <div class="container">
            <ul class="nav nav-pills mb-3 justify-content-center sticky-top bg-white" style="width: 120px; background-color: white" id="pills-tab" role="tablist">
                <li class="nav-item" role="presentation">
                    <a class="nav-link active" id="pills-home-tab" data-toggle="pill" href="#pills-home" role="tab"
                       aria-controls="pills-home" aria-selected="true">상품정보</a>
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link" id="pills-profile-tab" data-toggle="pill" href="#pills-profile" role="tab"
                       aria-controls="pills-profile" aria-selected="false">리뷰</a>
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link" id="pills-contact-tab" data-toggle="pill" href="#pills-contact" role="tab"
                       aria-controls="pills-contact" aria-selected="false">업체정보</a>
                </li>
            </ul>
            <div class="tab-content" id="pills-tabContent">
                <div class="tab-pane fade show active" id="pills-home" role="tabpanel"
                     aria-labelledby="pills-home-tab">
                    <img th:src="@{'/uploadImg/'+${product.productExpImg}}" class="d-block w-100" alt="..."></div>
                <div class="tab-pane fade" id="pills-profile" role="tabpanel"
                     aria-labelledby="pills-profile-tab"></div>
                <div class="tab-pane fade" id="pills-contact" role="tabpanel" aria-labelledby="pills-contact-tab">
                    <table class="table table-sm">
                        <tbody>
                        <tr>
                            <th scope="row">업체이름:</th>
                            <td th:text="${seller.sellerName}"></td>
                        </tr>
                        <tr>
                            <th scope="row">업체관리자전화번호:</th>
                            <td th:text="${seller.managerTel}"></td>
                        </tr>
                        <tr>
                            <th scope="row">업체관리자이메일:</th>
                            <td th:text="${seller.managerEmail}"></td>
                        </tr>
                        <tr>
                            <th scope="row">주소:</th>
                            <td th:text="${seller.sellerAddr}"></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <script th:inline="javascript">

        var memId2 = [[${jsonText}]];
        var memId = JSON.parse(memId2);
        console.log("memId : " + memId);



        // 세션에서 아이디 받아와서 아이디 없으면 실행 시켜야됨 아이디 있으면 ajax로 db에 저장시켜야함
        // var memberId = sessionStorage.getSession(memberId);
        // if(memberId != null){
        // }

        var i = 0;
        //var arrValue = new Array();
        var goSession;
        var sessionCheck = sessionStorage.getItem("ProductNameSession");
        var localCheck = localStorage.getItem("saveL")
        if(localCheck == null){
        console.log("localSession 없음");
        }else{
            console.log("localSession 이ㅆ음");
        }

        var valList;
        var localStored = new Array();

        var a;
        var b;

        if(localCheck != null){
            localStored = JSON.parse(localCheck);
            console.log("로칼 stroed : " + localStored);
            b = localStored.length;
            console.log("로칼 len : " + b);
            for(var i=0; i<b ; i++){
                console.log(localStored[i]);
            }
        }else{
            console.log("localSession업음");
            b=0;
            console.log("stored없음");
        }

        if (sessionCheck != null) {
            var stored = JSON.parse(sessionCheck);
            a = stored.length;

        } else {
            valList = new Array();
            a = 0;
        }


        function saveSessionStorage() {
            if (memId == null) {

                console.log("saveSessionStorage 실행");
                // 변수를 선언한다.
                var value = document.getElementById("productNo").value;
                var colorValue = $('#colorSelect').text();
                var qtyValue = $("select[name=hohoBox]").val();
                console.log("colorValue : " + colorValue);
                //var colValue = document.getElementById("").value;
                //var qtyValue = document.getElementById("").value;
                console.log("productNoValue  :  " + value);
                console.log("qtyValue  :  " + qtyValue);

                var arr = [value, colorValue, qtyValue];
                console.log("arr ? " + arr);
                var list;
                /*


                var arr2 = ["잉", "이", "상"];
                console.log("arr : " + arr);
                localStorage.setItem("saveP", arr);
                var list = [arr, arr2];
                console.log("List입니다 : " + list);
                localStorage.setItem("saveL", JSON.stringify(list));
*/

                var localSessionItem = localStorage.getItem("saveL");
                console.log("localSessionItem" + localSessionItem);

                if (localSessionItem == null) {
                    console.log("localSessionItem is Null입니다")
                    b = 0;
                    console.log("before arr : " + arr);
                    localStored[0] = arr;
                    /*if(localStored == null){
                        localStored[0] = 1;
                    }*/
                    console.log(localStored[0]);
                    console.log("after arr : " + localStored);
                    //localStorage.setItem("saveL", localStored);
                    //localStored[b] = JSON.stringify(arr);
                    //console.log(localStored[b]);
                    localStorage.setItem("saveL", JSON.stringify(localStored));
                } else {
                    b = 0;
                    console.log("localSession is not Null : ");
                    for(var i = 0; i<localStored.length; i++) {
                        console.log("localStored : " + localStored);
                        if (localStored[b][0] == value && localStored[b][1] == colorValue) {
                            console.log("로컬 이미 저장돼있습니다");
                            break;
                        }
                        if(localStored[b+1] == undefined){
                            console.log("흠 Null");
                            console.log(b);
                            localStored[b+1]=arr;
                            console.log("bf"+arr);
                            console.log("af"+JSON.stringify(arr));
                            console.log("b+1은? "+localStored[b+1]+" & localStored : "+localStored);
                            localStorage.setItem("saveL", JSON.stringify(localStored));
                            break;
                            }
                            b++;
                        }
                    }
// ㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡ 로컬끝
                    if (sessionCheck == null) {
                        console.log("sessionCheck is null");
                        while (true) {
                            console.log(a + "번째");
                            if (valList[a] == null) {
                                valList[a] = value;
                                break;
                            }
                            a++;
                        }
                        sessionStorage.setItem("ProductNameSession", JSON.stringify(valList));
                    } else {
                        a = 0;
                        console.log("sessionCheck is  not null");
                        while (true) {
                            if (stored[a] == value) {
                                alert("세션 이미 저장돼있습니다");
                                break;
                            }
                            if (stored[a] == null) {
                                stored[a] = value;
                                break;
                            } else {
                            }
                            a++;
                        }
                        sessionStorage.setItem("ProductNameSession", JSON.stringify(stored));
                    }


                    // setItem( ) 메서드를 이용하여 key를 지정하고, value값을 세션에 저장한다.
                    // sessionStorage.setItem(key, value);
                    //console.log("@@@@@@@@@@@@@@@ valList : "+valList);
                ajaxSessionStorage();
                }
            else
                {
                    console.log("memId : ~ajax " + memId);

                    var selectOption = document.getElementById("inputGroupSelect01");
                    console.log(selectOption);
                    selectOption = selectOption.options[selectOption.selectedIndex].value;
                    console.log("옵션 : " + selectOption);
                    var qty = document.getElementById("qty").value;
                    console.log("qty : " + qty | 0);
                    //var pName = document.getElementById("pName").value;
                    //console.log("pName" + pName);
                    var pNo = document.getElementById("productNo").value;
                    console.log("pNo" + pNo);

                    if (qty == "") {
                        alert("숫자 입력하세요");

                    } else {
                        $.ajax({ // 세션 보내기 ajax
                            //console.log("hi");
                            url: "/basketMember",
                            type: "POST",
                            data: {
                                memberId: memId,
                                productNo: pNo,
                                productColor: selectOption,
                                qty: qty
                            }
                            ,
                            success: function (e) {
                                alert("basketMem 완료")

                            },
                            error: function () {
                                alert("test err");
                            }
                        });
                    }

                }
            }

            function ajaxSessionStorage() {

            console.log("ajaxSessionStorage 실행");
            hoho = [localStorage.getItem("saveL")];
            console.log("real"+hoho+"len"+hoho.length);
            hoSession = JSON.parse(localStorage.getItem("saveL"));
            console.log("ex"+hoSession.length+hoSession);
           /* JSON.stringify(hoSession);
            console.log("af"+JSON.stringify(hoSession).length+JSON.stringify(hoSession));
            JSON.parse(hoSession);
            console.log("prse :" + JSON.parse(hoSession).length+JSON.parse(hoSession));*/
                var go='ho';
                $.ajax({ // 세션 보내기 ajax
                    //console.log("hi");
                    url: "/basketLocal",
                    type: "POST",
                    dataType : 'json',
                    traditional: true,
                    data: {'hoho': hoSession}
                    ,
                    success: function (e) {
                        alert("ajax완료")
                    },error: function () {
                        console.log("test err");
                    }
            });

            /*console.log("ajaxSessionStorage 실행");
                var i = 0;

                goSession = sessionStorage.getItem("ProductNameSession")
                console.log("exgoSession" + goSession);
                JSON.parse(goSession);
                console.log("afgoSession" + goSession);
                $.ajax({ // 세션 보내기 ajax
                    //console.log("hi");
                    url: "/basketSession",
                    type: "POST",
                    traditional: true,
                    data: {'hoho': goSession}
                    ,
                    success: function (e) {
                        var result = e.result
                        console.log("success");
                        //console.log(hoho3);
                        console.log(e);
                        alert("ajax완료")

                    },
                    error: function () {
                        alert("test err");
                    }
                });*/
            }

    </script>
</div>
</body>
</html>
